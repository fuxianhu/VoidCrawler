#include "MediaPlayer.h"

AudioPlayer::AudioPlayer(QWidget* parent)
	: QMainWindow(parent)
{
	setAttribute(Qt::WA_DeleteOnClose); // 关闭时自动释放内存

	// 不在任务栏显示图标    无边框窗口，以便自定义标题栏样式    置顶窗口
	this->setWindowFlags(Qt::Tool | Qt::FramelessWindowHint | Qt::WindowStaysOnTopHint);

	resize(400, 200);
	QWidget* w = new QWidget(this);
	w->setObjectName("centralWidget");
	w->setStyleSheet("background: transparent;");
	setCentralWidget(w);

    // 圆角遮罩
    QSize s = w->size();
    QBitmap bitmap(s);
    bitmap.fill(Qt::color0);
    QPainter painter(&bitmap);
    painter.setRenderHint(QPainter::Antialiasing);
    painter.setBrush(Qt::color1);
    painter.setPen(Qt::NoPen);
    QRectF r(0.0, 0.0, s.width(), s.height());
    qreal radius = 20.0; // 圆角半径
    painter.drawRoundedRect(r, radius, radius);
    painter.end();
    w->setMask(QRegion(bitmap));
    // 监听w的resize事件以适配动态圆角
    w->installEventFilter(this);

    // UI全部渲染在w上
    player = new QMediaPlayer(w);
    titleLabel = new QLabel(w);
	QFont titleFont = QFont("Arial", 30, QFont::Bold);
	titleLabel->setFont(titleFont);
    titleLabel->setText("Once upon a time");
    titleLabel->move(20, 20);
}

// 事件过滤器，动态更新圆角遮罩
bool AudioPlayer::eventFilter(QObject* watched, QEvent* event)
{
    if (watched == centralWidget() && event->type() == QEvent::Resize) {
        QWidget* w = qobject_cast<QWidget*>(watched);
        if (w) {
            QSize s = w->size();
            QBitmap bitmap(s);
            bitmap.fill(Qt::color0);
            QPainter painter(&bitmap);
            painter.setRenderHint(QPainter::Antialiasing);
            painter.setBrush(Qt::color1);
            painter.setPen(Qt::NoPen);
            QRectF r(0.0, 0.0, s.width(), s.height());
            qreal radius = 20.0;
            painter.drawRoundedRect(r, radius, radius);
            painter.end();
            w->setMask(QRegion(bitmap));
        }
    }
    return QMainWindow::eventFilter(watched, event);
}

AudioPlayer::~AudioPlayer()
{
	delete player;
}