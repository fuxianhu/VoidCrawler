#include "VoidCrawler.h"
#include <QApplication>
#include <QWidget>
#include <QGraphicsDropShadowEffect>
#include <QGraphicsBlurEffect>
#include <QDir>
#include <QtWidgets/QPushButton>
#include <QFont>
#include <QBitmap>
#include <QPainter>
#include <QResizeEvent>
#include <QMouseEvent>
#include <QPropertyAnimation>
#include <QPixmap>


// Small QPushButton subclass that supports a 'rotation' property for animation
class RotatableIconButton : public QPushButton {
    Q_OBJECT
    Q_PROPERTY(qreal rotation READ rotation WRITE setRotation)
public:
    RotatableIconButton(QWidget* parent = nullptr) : QPushButton(parent), m_rotation(0) {}
    qreal rotation() const { return m_rotation; }
    void setRotation(qreal r) {
        m_rotation = r;
        update();
    }
protected:
    void paintEvent(QPaintEvent* event) override {
        Q_UNUSED(event)
        QPainter p(this);
        p.setRenderHint(QPainter::SmoothPixmapTransform);
        p.setRenderHint(QPainter::Antialiasing);
        p.translate(width()/2.0, height()/2.0);
        p.rotate(m_rotation);
        p.translate(-width()/2.0, -height()/2.0);
        if (!icon().isNull()) {
            QSize sz = iconSize();
            QRect r((width()-sz.width())/2, (height()-sz.height())/2, sz.width(), sz.height());
            QPixmap pm = icon().pixmap(sz);
            p.drawPixmap(r, pm);
        } else {
            QPushButton::paintEvent(event);
        }
    }
private:
    qreal m_rotation;
};


VoidCrawler::VoidCrawler(QWidget *parent) : QMainWindow(parent)
{
    ui.setupUi(this);

    // 初始化多语言翻译器
    translator = new QTranslator(this);

    // 之后应该更改语言、初始化ui等
}

// 初始化UI界面函数
void VoidCrawler::initUI()
{
    //this->acceptDrops(); // 允许拖放文件，但这是很久以后的功能了

    // 创建一个中央部件并设置为主窗口的 central widget
    QWidget* w = new QWidget(this);
    w->setObjectName("centralWidget");
    w->setStyleSheet("background: transparent;");
    this->setCentralWidget(w);

    this->setWindowFlags(Qt::FramelessWindowHint);
    this->resize(300, m_expandedHeight);
    this->setWindowTitle("VoidCrawler Client");
    this->setWindowIcon(QIcon(QDir::currentPath() + "/icon.ico"));
    this->setStyleSheet("QMainWindow { background-color: #000000; }");

    // 创建自定义标题栏（顶部）
    m_titleBar = new QWidget(this);
    m_titleBar->setObjectName("titleBar");
    int titleBarHeight = 48;
    m_titleBar->setGeometry(0, 0, this->width(), titleBarHeight);
    // 使标题栏四角均为圆角，以便与窗口圆角一致
    m_titleBar->setStyleSheet(
        "QWidget#titleBar {"
        "background: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #111111, stop:1 #0b0b0b);"
        "border-radius: 12px;"
        "}");

    // 标题文字，居中显示
    m_titleLabel = new QLabel(this);
    m_titleLabel->setText("VoidCrawler Client");
    m_titleLabel->setGeometry(0, 0, this->width(), titleBarHeight);
    m_titleLabel->setAlignment(Qt::AlignCenter);
    m_titleLabel->setStyleSheet("color: white; background: transparent; font-size: 16px; font-weight: bold;");

    // 创建展开折叠按钮（右侧）
    m_toggleButton = new RotatableIconButton(this);
    QPixmap ico((QDir::currentPath() + "/favicon.ico"));
    if (!ico.isNull()) {
        m_toggleButton->setIcon(QIcon(ico));
        m_toggleButton->setIconSize(QSize(20,20));
    } else {
        m_toggleButton->setText("v");
    }
    m_toggleButton->setFixedSize(36, 36);
    m_toggleButton->setStyleSheet("background: transparent; border: none; color: white;");

    // 点击时执行动画：旋转 0 <-> 180 且同时改变窗口高度
    QObject::connect(m_toggleButton, &QPushButton::clicked, [this]() {
        // rotation animation
        qreal start = m_expanded ? 180.0 : 0.0;
        qreal end = m_expanded ? 0.0 : 180.0;
        QPropertyAnimation* rotAnim = new QPropertyAnimation(m_toggleButton, "rotation");
        rotAnim->setDuration(300);
        rotAnim->setStartValue(start);
        rotAnim->setEndValue(end);
        rotAnim->setEasingCurve(QEasingCurve::InOutCubic);
        rotAnim->start(QAbstractAnimation::DeleteWhenStopped);

        // geometry animation (change height)
        QRect startGeom = this->geometry();
        int targetHeight = m_expanded ? m_collapsedHeight : m_expandedHeight;
        QRect endGeom(startGeom.x(), startGeom.y(), startGeom.width(), targetHeight);
        QPropertyAnimation* geomAnim = new QPropertyAnimation(this, "geometry");
        geomAnim->setDuration(300);
        geomAnim->setStartValue(startGeom);
        geomAnim->setEndValue(endGeom);
        geomAnim->setEasingCurve(QEasingCurve::InOutCubic);
        geomAnim->start(QAbstractAnimation::DeleteWhenStopped);

        m_expanded = !m_expanded;
    });

    // 支持拖动窗口：在标题栏捕获鼠标事件
    m_titleBar->installEventFilter(this);
    m_titleLabel->installEventFilter(this);
    m_toggleButton->installEventFilter(this);

    // 在初始化时应用一次圆角遮罩
    QResizeEvent ev(this->size(), this->size());
    this->resizeEvent(&ev);

}

VoidCrawler::~VoidCrawler()
{
    delete translator; // 虽然没有使用智能指针，但也是安全的
}

// 覆盖resizeEvent以对窗角应用圆角遮罩
void VoidCrawler::resizeEvent(QResizeEvent* event)
{
    // 调用基类实现以保持行为一致
    QMainWindow::resizeEvent(event);

    // 重新布局标题栏和标题标签宽度
    if (m_titleBar) {
        int titleBarHeight = m_titleBar->height();
        m_titleBar->setGeometry(0, 0, this->width(), titleBarHeight);
    }
    if (m_titleLabel) {
        int titleBarHeight = m_titleLabel->height();
        m_titleLabel->setGeometry(0, 0, this->width(), titleBarHeight);
    }
    if (m_toggleButton) {
        int titleBarHeight = (m_titleBar ? m_titleBar->height() : 48);
        // place button at right with some margin
        int btnW = m_toggleButton->width();
        int x = this->width() - btnW - 8;
        int y = (titleBarHeight - m_toggleButton->height())/2;
        m_toggleButton->setGeometry(x, y, btnW, m_toggleButton->height());
    }

    // 创建一个位图作为遮罩，使用抗锯齿绘制圆角矩形
    QSize s = this->size();
    QBitmap bitmap(s);
    bitmap.fill(Qt::color0);

    QPainter painter(&bitmap);
    painter.setRenderHint(QPainter::Antialiasing);
    painter.setBrush(Qt::color1);
    painter.setPen(Qt::NoPen);
    QRectF r(0.0, 0.0, s.width(), s.height());
    qreal radius = static_cast<qreal>(m_cornerRadius);
    painter.drawRoundedRect(r, radius, radius);
    painter.end();

    // 将生成的位图设置为窗口遮罩
    this->setMask(QRegion(bitmap));
}

// 处理标题栏的拖动行为
bool VoidCrawler::eventFilter(QObject* watched, QEvent* event)
{
    if ((watched == m_titleBar || watched == m_titleLabel || watched == m_toggleButton) && event) {
        switch (event->type()) {
            case QEvent::MouseButtonPress: {
                QMouseEvent* me = static_cast<QMouseEvent*>(event);
                if (me->button() == Qt::LeftButton) {
                    m_dragging = true;
                    m_dragPosition = me->globalPosition().toPoint() - this->frameGeometry().topLeft();
                    return true;
                }
                break;
            }
            case QEvent::MouseMove: {
                if (m_dragging) {
                    QMouseEvent* me = static_cast<QMouseEvent*>(event);
                    this->move(me->globalPosition().toPoint() - m_dragPosition);
                    return true;
                }
                break;
            }
            case QEvent::MouseButtonRelease: {
                QMouseEvent* me = static_cast<QMouseEvent*>(event);
                if (me->button() == Qt::LeftButton) {
                    m_dragging = false;
                    return true;
                }
                break;
            }
            default:
                break;
        }
    }
    return QMainWindow::eventFilter(watched, event);
}

// 更改客户端语言，注意：更改语言后需要重新启动客户端以应用更改。（刚启动软件时除外）
void VoidCrawler::changeLanguage(const QString& language)
{
    // 卸载当前翻译器
    QApplication::removeTranslator(translator);

    // 加载新的翻译文件
    if (translator->load(QString(":/translations/%1.qm").arg(language)))
    {
        QApplication::installTranslator(translator);
    }
}

#include "VoidCrawler.moc"