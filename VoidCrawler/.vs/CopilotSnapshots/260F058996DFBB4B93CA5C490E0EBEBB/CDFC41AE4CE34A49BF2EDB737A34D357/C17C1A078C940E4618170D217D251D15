#include "VoidCrawler.h"
#include <QApplication>
#include <QWidget>
#include <QGraphicsDropShadowEffect>
#include <QGraphicsBlurEffect>
#include <QDir>
#include <QtWidgets/QPushButton>
#include <QFont>
#include <QBitmap>
#include <QPainter>
#include <QResizeEvent>


VoidCrawler::VoidCrawler(QWidget *parent) : QMainWindow(parent)
{
    ui.setupUi(this);

    // 初始化多语言翻译器
	translator = new QTranslator(this);

	// 之后应该更改语言、初始化ui等
}

// 初始化UI界面函数
void VoidCrawler::initUI()
{
	//this->acceptDrops(); // 允许拖放文件，但这是很久以后的功能了

    // 创建一个中央部件并设置为主窗口的 central widget
    QWidget* w = new QWidget(this);
    w->setObjectName("centralWidget");
    w->setStyleSheet("background: transparent;");
    this->setCentralWidget(w);

    this->setWindowFlags(Qt::FramelessWindowHint);
    this->resize(300, 800);
    this->setWindowTitle("VoidCrawler Client");
    this->setWindowIcon(QIcon(QDir::currentPath() + "/icon.ico"));
    this->setStyleSheet("QMainWindow { background-color: #000000; }");

    // 在初始化时应用一次圆角遮罩
    // 调用 resizeEvent 等同于设置遮罩（也会在后续 resize 时更新）
    QResizeEvent ev(this->size(), this->size());
    this->resizeEvent(&ev);

}

VoidCrawler::~VoidCrawler()
{
    delete translator; // 虽然没有使用智能指针，但也是安全的
}

// Override resizeEvent to apply a rounded mask for window corners
void VoidCrawler::resizeEvent(QResizeEvent* event)
{
    // 调用基类实现以保持行为一致
    QMainWindow::resizeEvent(event);

    // 创建一个位图作为遮罩，使用抗锯齿绘制圆角矩形
    QSize s = this->size();
    QBitmap bitmap(s);
    bitmap.fill(Qt::color0);

    QPainter painter(&bitmap);
    painter.setRenderHint(QPainter::Antialiasing);
    painter.setBrush(Qt::color1);
    painter.setPen(Qt::NoPen);
    QRectF r(0.0, 0.0, s.width(), s.height());
    qreal radius = static_cast<qreal>(m_cornerRadius);
    painter.drawRoundedRect(r, radius, radius);
    painter.end();

    // 将生成的位图设置为窗口遮罩
    this->setMask(QRegion(bitmap));
}

// 更改客户端语言，注意：更改语言后需要重新启动客户端以应用更改。（刚启动软件时除外）
void VoidCrawler::changeLanguage(const QString& language)
{
    // 卸载当前翻译器
    QApplication::removeTranslator(translator);

	// 加载新的翻译文件
    if (translator->load(QString(":/translations/%1.qm").arg(language)))
    {
		QApplication::installTranslator(translator);
    }
}